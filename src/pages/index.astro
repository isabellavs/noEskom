---
import Layout from '../layouts/Layout.astro';
---

<script>
	async function getData() {
		try {
			// DoTHIS: Change 'xxx.xxx.xx.xxx' to the IP of the host on which the flask server runs
			await fetch('http://xxx.xxx.xxx.xxx:8000/')
			.then((response) => {return response.json()})
			.then((stage) => {

				const flaming = document.getElementById('flame')
				flaming.innerHTML = ('')
				const fetcher = document.getElementById('stage')
				var candles = Number(stage.data) - 1;
				var candleStr = "";
				// candles = 0 // test

				if (candles <= 0) {
					fetcher.style.background = 'var(--happy-indicator)'
					fetcher.style.color = 'rgb(var(--accent));'
					fetcher.innerHTML = "WhooHoo!"
					candleStr = String("<svg xmlns='http://www.w3.org/2000/svg' width='3em' height='3em' viewBox='0 0 512 512'><path fill='#FFE46A' d='M411.111 183.926c0-87.791-68.91-158.959-153.914-158.959S103.283 96.136 103.283 183.926c0 39.7 14.093 75.999 37.392 103.856h-.001l33.666 61.027c8.793 16.28 12.057 26.792 26.792 26.792h109.774c14.736 0 19.071-11.07 26.792-26.792l36.022-61.027h-.002c23.299-27.857 37.393-64.156 37.393-103.856z'/><path fill='#FFF0B7' d='M112.805 203.285c0-90.721 68.378-165.701 157.146-177.719a150.851 150.851 0 0 0-13.319-.599c-85.004 0-153.914 71.169-153.914 158.959c0 28.89 7.469 55.974 20.512 79.319c-6.75-18.749-10.425-38.932-10.425-59.96z'/><path fill='#FFDA00' d='M411.111 184.266c0-31.445-8.843-60.755-24.097-85.428a160.416 160.416 0 0 1 4.917 39.416c0 104.454-101.138 189.522-227.481 192.967l9.89 17.929c8.793 16.28 12.057 26.792 26.792 26.792h109.774c14.736 0 19.071-11.07 26.792-26.792l36.022-61.027h-.002c23.299-27.858 37.393-64.157 37.393-103.857z'/><path fill='#FAAF63' d='M321.905 211.203c.149-.131.297-.251.447-.395c2.787-2.667 5.082-6.921 3.161-10.867c-7.879-16.176-31.97-21.308-49.524-15.951c-.889.271-1.751.566-2.588.885c-9.562-5.583-21.434-6.925-32.001-3.569a35.399 35.399 0 0 0-3.678 1.394c-5.785-3.38-12.552-5.066-19.294-4.414c-14.112 1.365-26.375 12.81-28.805 26.752l-1.112.688c9.617 15.541 34.93 60.071 36.552 79.233c2.045 24.174.002 89.793-.019 90.453l11.994.379c.086-2.723 2.086-66.978-.019-91.844c-.938-11.087-7.722-28.758-20.164-52.521c-5.807-11.092-11.445-20.83-14.858-26.576c2.36-7.646 9.61-13.848 17.586-14.619c2.429-.235 4.893.037 7.251.729a22.68 22.68 0 0 0-2.32 3.638c-4.047 7.935-2.356 17.898 3.933 23.176c3.725 3.125 9.137 4.276 14.127 3c4.647-1.188 8.239-4.242 9.854-8.379c1.451-3.718 1.328-8.01-.367-12.756a30.665 30.665 0 0 0-4.05-7.655a28.134 28.134 0 0 1 13.61.744c-1.715 1.975-3.027 4.173-3.89 6.556c-1.844 5.101-1.029 11.163 2.128 15.822c2.721 4.016 6.856 6.403 11.348 6.551c.15.005.301.008.45.008c3.935 0 7.67-1.692 10.562-4.797c3.397-3.647 5.126-8.71 4.624-13.544c-.319-3.073-1.412-6.079-3.172-8.867c12.236-2.223 24.205 1.911 29.383 8.186c-3.125 5.2-9.542 16.11-16.178 28.785c-12.441 23.764-19.227 41.435-20.164 52.521c-2.104 24.866-.104 89.121-.019 91.844l11.994-.379c-.021-.66-2.064-66.275-.019-90.453c1.459-17.251 22.113-55.046 33.237-73.758zm-80.657-3.171c-.279.716-1.331 1.035-1.647 1.116c-1.25.319-2.665.086-3.442-.565c-2.015-1.691-2.453-5.599-.957-8.532a11.21 11.21 0 0 1 1.85-2.583c1.611 1.828 2.892 3.926 3.707 6.208c.665 1.86.843 3.449.489 4.356zm32.19.654c-.351.375-1.065.992-1.839.976c-.831-.027-1.489-.819-1.808-1.289c-.993-1.467-1.312-3.527-.776-5.009c.618-1.71 1.811-3.109 3.203-4.235c1.55 1.751 2.501 3.634 2.688 5.434c.144 1.371-.447 3.027-1.468 4.123z'/><path fill='#6B83A5' d='M315.932 402.701H197.897c-6.6 0-12 5.4-12 12v6.957c0 6.6 5.4 12 12 12h38.122c-11.367 4.229-23.369 14.285-23.369 25.946v4.68c9.123 10.254 17.619 28.081 33.802 28.081h21.89c12.748 0 21.804-13.762 32.836-28.081v-4.68c0-11.661-11.451-21.717-22.548-25.946h37.302c6.6 0 12-5.4 12-12v-6.957c0-6.6-5.4-12-12-12z'/><path fill='#ABBDDB' d='M324.406 402.701H189.423c-6.6 0-12-5.4-12-12v-6.957c0-6.6 5.4-12 12-12h134.983c6.6 0 12 5.4 12 12v6.957c0 6.6-5.4 12-12 12zm-7.007 49.915v-6.957c0-6.6-5.4-12-12-12H208.43c-6.6 0-12 5.4-12 12v6.957c0 6.6 5.4 12 12 12h96.969c6.6 0 12-5.4 12-12z'/></svg>")
				} else {
					var i = 0;
					document.getElementById('stage').style.background = 'var(--fury-indicator)';
					document.getElementById('stage').style.color = 'black'
					while (i < candles) {
						candleStr = candleStr + String("<svg xmlns='http://www.w3.org/2000/svg' width='3em' height='3em' viewBox='0 0 72 72'><path fill='#FFF' d='m41.67 32.658l-12.894-.062v31.008h12.506z'/><path fill='#d0cfce' d='M37.343 63.604h4.327V32.548l-4.327-.019z'/><path fill='#FCEA2B' d='M30.139 16c0 1.978-.013 4.86.428 6.32c.16.527 1.16 2.21.633 2.37h8.558c-.036-.009-.136.007-.109-.02c.812-.772.812-.772 1.007-1.289c.584-1.545.518-4.32.116-6.56c-.52-2.9-3.95-7.176-5.165-8.518C34.2 9.78 30.14 12.967 30.14 16z'/><path fill='#FFF' d='M35.372 23.735v4.041'/><path fill='none' stroke='#000' stroke-linecap='round' stroke-linejoin='round' stroke-miterlimit='10' stroke-width='2' d='M30.908 23.735c-.426-1.411-.77-3.69-.77-5.95c0-4.416 5.47-9.482 5.47-9.482s4.406 4.293 5.164 8.517c.433 2.41-.125 5.21-.769 6.915M28.776 63.604H41.67V32.596l-12.894-.067zm6.596-39.869v4.041'/></svg>")
						i += 1;
					}
					fetcher.innerHTML = "Stage " + candles
				}

				flaming.style.transform = 'scale(1,1)'
				flaming.innerHTML = candleStr;
			})
		}
		catch(ERR) {
			return 404
		}
	}

	const stageButton = document.querySelector('button.stage')
	stageButton.addEventListener('click', () => {
		const flamer = document.getElementById('flame')
		flamer.style.transform = 'scale(1,1.5)'
		getData();
	});

	const clearButton = document.getElementById('clear')
	clearButton.addEventListener('click', () => {
		document.getElementById('flame').innerHTML = ""
		const getter = document.getElementById('stage')
		getter.style.background = 'white'
		getter.style.color = 'rgb(var(--accent))'
		getter.innerHTML = "Candle Indicator"
	});
</script>

<Layout title="Candle Indicator">
	<main>
		<h1>noEskom <span class="text-gradient">Level</span></h1>
		<p class="instructions">
			Check the current <strong>Loadshedding</strong> status.
		</p>
		<div class="button-container">
			<button id="stage" class="stage">
				Candle Indicator
			</button>
			<button type="reset" class="stage" id="clear">
				Clear
			</button>
		</div>
		<br><br>
		<div id="flame"></div>
	</main>
</Layout>

<style>
	main {
		margin: auto;
		padding: 1.5rem;
		max-width: 60ch;
	}
	h1 {
		font-size: 3rem;
		font-weight: 800;
		margin: 0;
	}
	#flame {
		font-size: 3em;
		/*transition: all 0.8s ease;*/
		transition: transform 0.8s;
	}
	.text-gradient {
		background-image: var(--fury-indicator);
		-webkit-background-clip: text;
		-webkit-text-fill-color: transparent;
		background-size: 400%;
		background-position: 0%;
	}
	.instructions {
		line-height: 1.6;
		margin: 1rem 0;
		/*border: 1px solid rgba(var(--accent), 25%);*/
		background-color: white;
		padding: 1rem;
		border-radius: 0.4rem;
		text-align: center;
	}
	.instructions code {
		font-size: 0.875em;
		font-weight: bold;
		background: rgba(var(--accent), 12%);
		color: rgb(var(--accent));
		border-radius: 4px;
		padding: 0.3em 0.45em;
	}
	.instructions strong {
		color: rgb(var(--accent));
	}
	.stage {
		border: 1px solid rgba(var(--accent), 25%);
		background: white;
		padding: 1rem;
		border-radius: 0.4rem;
		text-align: center;
		font-family: system-ui, sans-serif;
		font-weight: normal;
		font-size: 1em;
		font-weight: bolder;
		color: rgb(var(--accent));
		position: relative;
	}

</style>
